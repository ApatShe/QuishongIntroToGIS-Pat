
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>28. Distributed Computing with Apache Sedona &#8212; Introduction to GIS Programming</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'book/geospatial/sedona';</script>
    <link rel="canonical" href="https://gispro.gishub.org/book/geospatial/sedona.html" />
    <link rel="icon" href="../../_static/fav.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="27. Building Interactive Dashboards with VoilÃ  and Solara" href="solara.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Introduction to GIS Programming - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Introduction to GIS Programming - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Preface</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../preface.html">Preface</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Software Setup</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../software/overview.html">1. Overview of Software Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/conda.html">2. Introduction to Python Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/vscode.html">3. Setting Up Visual Studio Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/git.html">4. Version Control with Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/colab.html">5. Using Google Colab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/jupyterlab.html">6. Working with JupyterLab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/docker.html">7. Using Docker</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Python Programming Fundamentals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../python/variables.html">8. Variables and Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/data-structures.html">9. Python Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/string-operations.html">10. String Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/looping.html">11. Loops and Conditional Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/functions-classes.html">12. Functions and Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/files.html">13. Working with Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/numpy-pandas.html">14. Data Analysis with NumPy and Pandas</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Geospatial Programming with Python</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="get-started.html">15. Introduction to Geospatial Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="geopandas.html">16. Vector Data Analysis with GeoPandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="rasterio.html">17. Working with Raster Data Using Rasterio</a></li>
<li class="toctree-l1"><a class="reference internal" href="xarray.html">18. Multi-dimensional Data Analysis with Xarray</a></li>
<li class="toctree-l1"><a class="reference internal" href="rioxarray.html">19. Raster Analysis with Rioxarray</a></li>
<li class="toctree-l1"><a class="reference internal" href="leafmap.html">20. Interactive Visualization with Leafmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="whitebox.html">21. Geoprocessing with WhiteboxTools</a></li>
<li class="toctree-l1"><a class="reference internal" href="maplibre.html">22. 3D Mapping with MapLibre</a></li>
<li class="toctree-l1"><a class="reference internal" href="geemap.html">23. Cloud Computing with Earth Engine and Geemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="hypercoast.html">24. Hyperspectral Data Visualization with HyperCoast</a></li>
<li class="toctree-l1"><a class="reference internal" href="duckdb.html">25. High-Performance Geospatial Analytics with DuckDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="gdal.html">26. Geospatial Data Processing with GDAL and OGR</a></li>
<li class="toctree-l1"><a class="reference internal" href="solara.html">27. Building Interactive Dashboards with VoilÃ  and Solara</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">28. Distributed Computing with Apache Sedona</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/giswqs/intro-gispro/main?urlpath=tree/book/geospatial/sedona.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/giswqs/intro-gispro/blob/main/book/geospatial/sedona.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/giswqs/intro-gispro" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/giswqs/intro-gispro/edit/main/book/geospatial/sedona.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/giswqs/intro-gispro/issues/new?title=Issue%20on%20page%20%2Fbook/geospatial/sedona.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/book/geospatial/sedona.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Distributed Computing with Apache Sedona</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">28.1. Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">28.2. Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-and-setting-up-apache-sedona">28.3. Installing and Setting Up Apache Sedona</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#installation-requirements">28.3.1. Installation Requirements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#core-imports-and-configuration">28.3.2. Core Imports and Configuration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-sedona-enabled-spark-session">28.3.3. Creating a Sedona-Enabled Spark Session</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-sample-data">28.4. Downloading Sample Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#core-concepts-and-data-structures">28.5. Core Concepts and Data Structures</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-spatial-dataframes">28.5.1. Understanding Spatial DataFrames</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-data-types">28.5.2. Spatial Data Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-spatial-dataframes">28.5.3. Creating Spatial DataFrames</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-real-geospatial-data">28.5.4. Working with Real Geospatial Data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-operations-and-functions">28.6. Spatial Operations and Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-geometric-properties">28.6.1. Basic Geometric Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-calculations">28.6.2. Distance Calculations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-relationships">28.6.3. Spatial Relationships</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-joins-and-indexing">28.7. Spatial Joins and Indexing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-spatial-join-types">28.7.1. Understanding Spatial Join Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-spatial-joins-with-world-cities">28.7.2. Performing Spatial Joins with World Cities</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-join-example-cities-by-country">28.7.3. Spatial Join Example: Cities by Country</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-spatial-analysis">28.8. Advanced Spatial Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-aggregations">28.8.1. Spatial Aggregations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-clustering-analysis">28.8.2. Spatial Clustering Analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-vector-data">28.9. Reading Vector Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-csv">28.9.1. Reading CSV</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-geojson">28.9.2. Reading GeoJSON</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-shapefiles">28.9.3. Reading Shapefiles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-geopackage">28.9.4. Reading GeoPackage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-geoparquet">28.9.5. Reading GeoParquet</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-cloud-stored-data">28.9.6. Reading Cloud-Stored Data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-vector-data">28.10. Visualizing Vector Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-keplergl">28.10.1. Using KeplerGL</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-pydeck">28.10.2. Using PyDeck</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-vector-data">28.11. Writing Vector Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-raster-data">28.12. Reading Raster Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-netcdf">28.12.1. Reading NetCDF</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-geotiff">28.12.2. Reading GeoTIFF</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-raster-data">28.13. Visualizing Raster Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#raster-map-algebra">28.14. Raster Map Algebra</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#raster-zonal-statistics">28.15. Raster Zonal Statistics</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-raster-data">28.16. Writing Raster Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#integration-with-geopandas">28.17. Integration with GeoPandas</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-sedona-dataframe-to-geopandas-geodataframe">28.17.1. From Sedona DataFrame to GeoPandas GeoDataFrame</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-sedona-dataframe-to-geoarrow">28.17.2. From Sedona DataFrame To GeoArrow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-geopandas-geodataframe-to-sedona-dataframe">28.17.3. From GeoPandas GeoDataFrame to Sedona DataFrame</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-integration-converting-through-geoarrow">28.17.4. Advanced Integration: Converting Through GeoArrow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-conversion-functions">28.17.5. Custom Conversion Functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#real-world-use-cases">28.18. Real-World Use Cases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-1-global-urban-density-analysis">28.18.1. Use Case 1: Global Urban Density Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-2-transit-accessibility-assessment">28.18.2. Use Case 2: Transit Accessibility Assessment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">28.19. Key Takeaways</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references-and-further-reading">28.20. References and Further Reading</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">28.21. Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-setting-up-sedona-and-basic-spatial-operations">28.21.1. Exercise 1: Setting Up Sedona and Basic Spatial Operations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-working-with-real-geospatial-data">28.21.2. Exercise 2: Working with Real Geospatial Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-distance-analysis">28.21.3. Exercise 3: Distance Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-spatial-joins">28.21.4. Exercise 4: Spatial Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-spatial-aggregation-and-clustering">28.21.5. Exercise 5: Spatial Aggregation and Clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-6-buffer-analysis">28.21.6. Exercise 6: Buffer Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-7-spatial-sql-queries">28.21.7. Exercise 7: Spatial SQL Queries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-8-advanced-spatial-analysis">28.21.8. Exercise 8: Advanced Spatial Analysis</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="distributed-computing-with-apache-sedona">
<h1><span class="section-number">28. </span>Distributed Computing with Apache Sedona<a class="headerlink" href="#distributed-computing-with-apache-sedona" title="Link to this heading">#</a></h1>
<section id="introduction">
<h2><span class="section-number">28.1. </span>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
</section>
<section id="learning-objectives">
<h2><span class="section-number">28.2. </span>Learning Objectives<a class="headerlink" href="#learning-objectives" title="Link to this heading">#</a></h2>
</section>
<section id="installing-and-setting-up-apache-sedona">
<h2><span class="section-number">28.3. </span>Installing and Setting Up Apache Sedona<a class="headerlink" href="#installing-and-setting-up-apache-sedona" title="Link to this heading">#</a></h2>
<section id="installation-requirements">
<h3><span class="section-number">28.3.1. </span>Installation Requirements<a class="headerlink" href="#installation-requirements" title="Link to this heading">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>-p<span class="w"> </span><span class="m">8888</span>:8888<span class="w"> </span>-p<span class="w"> </span><span class="m">4040</span>:4040<span class="w"> </span>-p<span class="w"> </span><span class="m">8080</span>:8080<span class="w"> </span>-p<span class="w"> </span><span class="m">8082</span>:8081<span class="w"> </span>-p<span class="w"> </span><span class="m">7077</span>:7077<span class="w"> </span>-p<span class="w"> </span><span class="m">8085</span>:8085<span class="w"> </span>-v<span class="w"> </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/app/workspace<span class="w"> </span>giswqs/pygis:sedona
</pre></div>
</div>
</section>
<section id="core-imports-and-configuration">
<h3><span class="section-number">28.3.2. </span>Core Imports and Configuration<a class="headerlink" href="#core-imports-and-configuration" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>import leafmap
import geopandas as gpd
import pandas as pd
from sedona.spark import *
from pyspark.sql.functions import col, expr
</pre></div>
</div>
</div>
</div>
</section>
<section id="creating-a-sedona-enabled-spark-session">
<h3><span class="section-number">28.3.3. </span>Creating a Sedona-Enabled Spark Session<a class="headerlink" href="#creating-a-sedona-enabled-spark-session" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config = (
    SedonaContext.builder()
    .appName(&quot;SedonaApp&quot;)  # Application name for tracking in Spark UI
    .config(
        &quot;spark.serializer&quot;, &quot;org.apache.spark.serializer.KryoSerializer&quot;
    )  # Faster serialization
    .config(
        &quot;spark.kryo.registrator&quot;, &quot;org.apache.sedona.core.serde.SedonaKryoRegistrator&quot;
    )  # Spatial object serialization
    .config(
        &quot;spark.jars.packages&quot;,
        &quot;org.apache.sedona:sedona-spark-shaded-3.5_2.12:1.7.2,org.datasyslab:geotools-wrapper:1.7.2-28.5&quot;,
    )  # Core Sedona packages
    .config(
        &quot;spark.jars.repositories&quot;,
        &quot;https://artifacts.unidata.ucar.edu/repository/unidata-all&quot;,
    )  # Additional repositories
    .config(
        &quot;spark.hadoop.fs.s3a.connection.ssl.enabled&quot;, &quot;true&quot;
    )  # Enable SSL for S3 connections
    .config(
        &quot;spark.hadoop.fs.s3a.path.style.access&quot;, &quot;true&quot;
    )  # Use path-style access for S3
    .config(
        &quot;spark.hadoop.fs.s3a.impl&quot;, &quot;org.apache.hadoop.fs.s3a.S3AFileSystem&quot;
    )  # S3 filesystem implementation
    .config(
        &quot;spark.hadoop.fs.s3a.aws.credentials.provider&quot;,
        &quot;org.apache.hadoop.fs.s3a.AnonymousAWSCredentialsProvider&quot;,
    )  # Anonymous access to public S3 buckets
    .getOrCreate()
)

# Create the Sedona context which adds spatial capabilities to the Spark session
sedona = SedonaContext.create(config)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="downloading-sample-data">
<h2><span class="section-number">28.4. </span>Downloading Sample Data<a class="headerlink" href="#downloading-sample-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>url = (
    &quot;https://github.com/opengeos/datasets/releases/download/book/sedona-sample-data.zip&quot;
)
leafmap.download_file(url)
</pre></div>
</div>
</div>
</div>
</section>
<section id="core-concepts-and-data-structures">
<h2><span class="section-number">28.5. </span>Core Concepts and Data Structures<a class="headerlink" href="#core-concepts-and-data-structures" title="Link to this heading">#</a></h2>
<section id="understanding-spatial-dataframes">
<h3><span class="section-number">28.5.1. </span>Understanding Spatial DataFrames<a class="headerlink" href="#understanding-spatial-dataframes" title="Link to this heading">#</a></h3>
</section>
<section id="spatial-data-types">
<h3><span class="section-number">28.5.2. </span>Spatial Data Types<a class="headerlink" href="#spatial-data-types" title="Link to this heading">#</a></h3>
</section>
<section id="creating-spatial-dataframes">
<h3><span class="section-number">28.5.3. </span>Creating Spatial DataFrames<a class="headerlink" href="#creating-spatial-dataframes" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Create sample city data with coordinates for major US cities
cities_data = [
    (&quot;New York&quot;, 40.7128, -74.0060),
    (&quot;Los Angeles&quot;, 34.0522, -118.2437),
    (&quot;Chicago&quot;, 41.8781, -87.6298),
    (&quot;Houston&quot;, 29.7604, -95.3698),
    (&quot;Phoenix&quot;, 33.4484, -112.0740),
]

# Convert to Spark DataFrame - this creates a distributed dataset
cities_df = sedona.createDataFrame(
    data=cities_data, schema=[&quot;city&quot;, &quot;latitude&quot;, &quot;longitude&quot;]
)

# Create geometry column using ST_Point function - this transforms coordinates into spatial objects
cities_spatial = cities_df.withColumn(&quot;geometry&quot;, expr(&quot;ST_Point(longitude, latitude)&quot;))

# Display the resulting spatial DataFrame
cities_spatial.show(truncate=False)
</pre></div>
</div>
</div>
</div>
</section>
<section id="working-with-real-geospatial-data">
<h3><span class="section-number">28.5.4. </span>Working with Real Geospatial Data<a class="headerlink" href="#working-with-real-geospatial-data" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Load NYC boroughs GeoJSON using GeoPandas for initial processing
boroughs_gdf = gpd.read_file(&quot;nybb.geojson&quot;)

# Reproject from New York State Plane (EPSG:2263) to Albers Equal Area (EPSG:5070)
# This ensures accurate area calculations for our later analysis
boroughs_gdf = boroughs_gdf.to_crs(&quot;EPSG:5070&quot;)
boroughs_gdf
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Convert to Pandas DataFrame and extract WKT (Well-Known Text) representation of geometries
boroughs_pd = pd.DataFrame(boroughs_gdf.drop(columns=&quot;geometry&quot;))
boroughs_pd[&quot;wkt_geometry&quot;] = boroughs_gdf.geometry.to_wkt()

# Create Spark DataFrame from the Pandas DataFrame
boroughs_df = sedona.createDataFrame(boroughs_pd)

# Convert WKT strings back to spatial geometry objects using Sedona&#39;s ST_GeomFromWKT function
boroughs_spatial = boroughs_df.withColumn(
    &quot;geometry&quot;, expr(&quot;ST_GeomFromWKT(wkt_geometry)&quot;)
)

# Display the key columns of our spatial DataFrame
boroughs_spatial.select(&quot;BoroCode&quot;, &quot;BoroName&quot;, &quot;geometry&quot;).show()
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="spatial-operations-and-functions">
<h2><span class="section-number">28.6. </span>Spatial Operations and Functions<a class="headerlink" href="#spatial-operations-and-functions" title="Link to this heading">#</a></h2>
<section id="basic-geometric-properties">
<h3><span class="section-number">28.6.1. </span>Basic Geometric Properties<a class="headerlink" href="#basic-geometric-properties" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Calculate geometric properties for each borough
boroughs_with_metrics = (
    boroughs_spatial.withColumn(
        &quot;area_km2&quot;, expr(&quot;ROUND(ST_Area(geometry) / 1e6, 2)&quot;)
    )  # Convert from mÂ² to kmÂ²
    .withColumn(
        &quot;perimeter_km&quot;, expr(&quot;ROUND(ST_Perimeter(geometry) / 1000, 2)&quot;)
    )  # Convert from m to km
    .withColumn(&quot;centroid&quot;, expr(&quot;ST_Centroid(geometry)&quot;))  # Calculate geometric center
)

# Display the calculated metrics
boroughs_with_metrics.select(&quot;BoroName&quot;, &quot;area_km2&quot;, &quot;perimeter_km&quot;, &quot;centroid&quot;).show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="distance-calculations">
<h3><span class="section-number">28.6.2. </span>Distance Calculations<a class="headerlink" href="#distance-calculations" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Transform city coordinates from geographic (EPSG:4326) to projected (EPSG:5070) coordinate system
# This is essential for accurate distance calculations in linear units (meters)
cities_projected = cities_spatial.withColumn(
    &quot;geometry&quot;, expr(&quot;ST_Transform(geometry, &#39;EPSG:4326&#39;, &#39;EPSG:5070&#39;)&quot;)
)

# View the transformed coordinates
cities_projected.show(truncate=False)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Calculate distances from each city to Manhattan&#39;s centroid
# First, extract Manhattan&#39;s centroid as a reference point
manhattan_centroid = (
    boroughs_spatial.filter(col(&quot;BoroName&quot;) == &quot;Manhattan&quot;)
    .select(expr(&quot;ST_Centroid(geometry)&quot;).alias(&quot;manhattan_center&quot;))
    .collect()[0][0]  # collect() brings the result to the driver node
)

# Create a new DataFrame with distance calculations
cities_with_distances = (
    cities_projected.withColumn(
        &quot;manhattan_center&quot;,
        expr(
            f&quot;ST_GeomFromWKT(&#39;{manhattan_centroid.wkt}&#39;)&quot;
        ),  # Add Manhattan center as reference
    )
    .withColumn(
        &quot;distance_to_manhattan_meters&quot;,
        expr(&quot;ST_Distance(geometry, manhattan_center)&quot;),  # Calculate distance in meters
    )
    .withColumn(
        &quot;distance_to_manhattan_km&quot;,
        expr(
            &quot;ROUND(ST_Distance(geometry, manhattan_center) / 1000, 2)&quot;
        ),  # Convert to kilometers and round
    )
)

# Display results ordered by distance (closest first)
cities_with_distances.select(&quot;city&quot;, &quot;distance_to_manhattan_km&quot;).orderBy(
    &quot;distance_to_manhattan_km&quot;
).show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="spatial-relationships">
<h3><span class="section-number">28.6.3. </span>Spatial Relationships<a class="headerlink" href="#spatial-relationships" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Create a 5-kilometer buffer around Manhattan&#39;s boundary
manhattan_with_buffer = boroughs_spatial.filter(
    col(&quot;BoroName&quot;) == &quot;Manhattan&quot;
).withColumn(
    &quot;buffer_5km&quot;, expr(&quot;ST_Buffer(geometry, 5000)&quot;)  # 5000 meters = 5km buffer
)

# Perform spatial join to find cities within the buffer zone
cities_in_buffer = (
    cities_projected.crossJoin(
        manhattan_with_buffer.select(&quot;buffer_5km&quot;)
    )  # Cross join to compare all cities with the buffer
    .withColumn(
        &quot;within_buffer&quot;, expr(&quot;ST_Within(geometry, buffer_5km)&quot;)
    )  # Test if city point is within buffer
    .filter(col(&quot;within_buffer&quot;) == True)  # Keep only cities that are within the buffer
)

# Display cities that fall within the 5km buffer of Manhattan
cities_in_buffer.select(&quot;city&quot;).show()
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="spatial-joins-and-indexing">
<h2><span class="section-number">28.7. </span>Spatial Joins and Indexing<a class="headerlink" href="#spatial-joins-and-indexing" title="Link to this heading">#</a></h2>
<section id="understanding-spatial-join-types">
<h3><span class="section-number">28.7.1. </span>Understanding Spatial Join Types<a class="headerlink" href="#understanding-spatial-join-types" title="Link to this heading">#</a></h3>
</section>
<section id="performing-spatial-joins-with-world-cities">
<h3><span class="section-number">28.7.2. </span>Performing Spatial Joins with World Cities<a class="headerlink" href="#performing-spatial-joins-with-world-cities" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>world_cities_pd = pd.read_csv(&quot;world_cities.csv&quot;)
world_cities_pd.head()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Convert Pandas DataFrame to Spark DataFrame for distributed processing
world_cities_df = sedona.createDataFrame(world_cities_pd)

# Create spatial point geometries from longitude and latitude columns
world_cities_spatial = world_cities_df.withColumn(
    &quot;geometry&quot;, expr(&quot;ST_Point(longitude, latitude)&quot;)
)

# Display sample data showing the spatial DataFrame structure
world_cities_spatial.show(10)
</pre></div>
</div>
</div>
</div>
</section>
<section id="spatial-join-example-cities-by-country">
<h3><span class="section-number">28.7.3. </span>Spatial Join Example: Cities by Country<a class="headerlink" href="#spatial-join-example-cities-by-country" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Create simplified country boundaries for demonstration
# In production, you would load actual country boundary data from sources like Natural Earth
sample_countries = [
    (
        &quot;Australia&quot;,
        &quot;POLYGON ((112 -44, 112 -10, 154 -10, 154 -44, 112 -44))&quot;,
    ),  # Simplified Australia bbox
    (
        &quot;UK&quot;,
        &quot;POLYGON ((-8.65 49.9, -8.65 60.9, 1.75 60.9, 1.75 49.9, -8.65 49.9))&quot;,
    ),  # Simplified UK bbox
]

# Create DataFrame with country boundaries
countries_df = sedona.createDataFrame(sample_countries, schema=[&quot;country&quot;, &quot;wkt&quot;])
countries_spatial = countries_df.withColumn(&quot;geometry&quot;, expr(&quot;ST_GeomFromWKT(wkt)&quot;))

# Perform spatial join to find cities within country boundaries
# This operation tests each city point against each country polygon
cities_in_countries = world_cities_spatial.alias(&quot;cities&quot;).join(
    countries_spatial.alias(&quot;countries&quot;),
    expr(
        &quot;ST_Within(cities.geometry, countries.geometry)&quot;
    ),  # Spatial predicate: city within country
    &quot;inner&quot;,  # Only keep cities that are within a country boundary
)
cities_in_countries.show()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Aggregate cities by country to get summary statistics
city_counts = cities_in_countries.groupBy(&quot;countries.country&quot;).count()
city_counts.show()
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="advanced-spatial-analysis">
<h2><span class="section-number">28.8. </span>Advanced Spatial Analysis<a class="headerlink" href="#advanced-spatial-analysis" title="Link to this heading">#</a></h2>
<section id="spatial-aggregations">
<h3><span class="section-number">28.8.1. </span>Spatial Aggregations<a class="headerlink" href="#spatial-aggregations" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Perform spatial and statistical aggregations on North American cities
country_unions = (
    world_cities_spatial.filter(
        col(&quot;country&quot;).isin(
            [&quot;USA&quot;, &quot;CAN&quot;, &quot;MEX&quot;]
        )  # Filter for North American countries
    )
    .groupBy(&quot;country&quot;)
    .agg(
        expr(&quot;ST_Union_Aggr(geometry)&quot;).alias(
            &quot;union_geometry&quot;
        ),  # Create union of all city points per country
        expr(&quot;COUNT(*)&quot;).alias(&quot;city_count&quot;),  # Count cities per country
        expr(&quot;CAST(AVG(population) AS INT)&quot;).alias(
            &quot;avg_population&quot;
        ),  # Calculate average population per country
    )
)

country_unions.show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="spatial-clustering-analysis">
<h3><span class="section-number">28.8.2. </span>Spatial Clustering Analysis<a class="headerlink" href="#spatial-clustering-analysis" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Create a 2-degree geographic grid for clustering analysis
grid_analysis = (
    world_cities_spatial.filter(
        col(&quot;population&quot;) &gt; 100000
    )  # Focus on major cities only
    .withColumn(
        &quot;grid_x&quot;, expr(&quot;floor(longitude / 2) * 2&quot;)
    )  # Create 2-degree longitude grid cells
    .withColumn(
        &quot;grid_y&quot;, expr(&quot;floor(latitude / 2) * 2&quot;)
    )  # Create 2-degree latitude grid cells
    .groupBy(&quot;grid_x&quot;, &quot;grid_y&quot;)  # Group cities by grid cell
    .agg(
        expr(&quot;COUNT(*)&quot;).alias(&quot;city_count&quot;),  # Count cities in each grid cell
        expr(&quot;SUM(population)&quot;).alias(
            &quot;total_population&quot;
        ),  # Sum population in each grid cell
        expr(&quot;ST_Centroid(ST_Union_Aggr(geometry))&quot;).alias(
            &quot;grid_center&quot;
        ),  # Calculate center of city cluster
    )
)

# Identify and display high-density urban clusters
high_density_grids = grid_analysis.filter(
    col(&quot;city_count&quot;) &gt;= 5
)  # Grid cells with 5+ major cities
high_density_grids.orderBy(col(&quot;city_count&quot;).desc()).show()
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="reading-vector-data">
<h2><span class="section-number">28.9. </span>Reading Vector Data<a class="headerlink" href="#reading-vector-data" title="Link to this heading">#</a></h2>
<section id="reading-csv">
<h3><span class="section-number">28.9.1. </span>Reading CSV<a class="headerlink" href="#reading-csv" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Read CSV file and create spatial geometries from coordinate columns
cities_df = (
    sedona.read.option(&quot;header&quot;, True)  # CSV has header row
    .format(&quot;CSV&quot;)
    .load(&quot;world_cities.csv&quot;)
    .withColumn(
        &quot;geometry&quot;, expr(&quot;ST_Point(longitude, latitude)&quot;)
    )  # Create point geometries from coords
)
cities_df.show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="reading-geojson">
<h3><span class="section-number">28.9.2. </span>Reading GeoJSON<a class="headerlink" href="#reading-geojson" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Read GeoJSON file - initial structure shows nested format
cables_df = sedona.read.format(&quot;geojson&quot;).load(&quot;cables.geojson&quot;)
cables_df.printSchema()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Flatten GeoJSON structure for easier analysis
cables_df = (
    sedona.read.format(&quot;geojson&quot;)
    .load(&quot;cables.geojson&quot;)
    .selectExpr(&quot;explode(features) as features&quot;)  # Expand the features array
    .select(&quot;features.*&quot;)  # Select all fields from features
    .withColumn(&quot;id&quot;, expr(&quot;properties[&#39;id&#39;]&quot;))  # Extract property fields
    .withColumn(&quot;name&quot;, expr(&quot;properties[&#39;name&#39;]&quot;))
    .withColumn(&quot;color&quot;, expr(&quot;properties[&#39;color&#39;]&quot;))
    .drop(&quot;properties&quot;)  # Remove nested properties object
    .drop(&quot;type&quot;)  # Remove type field
)
cables_df.show(5)
</pre></div>
</div>
</div>
</div>
</section>
<section id="reading-shapefiles">
<h3><span class="section-number">28.9.3. </span>Reading Shapefiles<a class="headerlink" href="#reading-shapefiles" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Read shapefile directly into spatial DataFrame
countries_df = sedona.read.format(&quot;shapefile&quot;).load(&quot;countries.shp&quot;)
countries_df.show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="reading-geopackage">
<h3><span class="section-number">28.9.4. </span>Reading GeoPackage<a class="headerlink" href="#reading-geopackage" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Read specific table from GeoPackage file
countries_df = (
    sedona.read.format(&quot;geopackage&quot;)
    .option(&quot;tableName&quot;, &quot;countries&quot;)  # Specify the table/layer name
    .load(&quot;countries.gpkg&quot;)
)
countries_df.show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="reading-geoparquet">
<h3><span class="section-number">28.9.5. </span>Reading GeoParquet<a class="headerlink" href="#reading-geoparquet" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Read GeoParquet files - optimized for large datasets
states_df = sedona.read.format(&quot;geoparquet&quot;).load(&quot;us_states.parquet&quot;)
states_df.show()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># GeoParquet is excellent for point datasets like cities
us_cities_df = sedona.read.format(&quot;geoparquet&quot;).load(&quot;us_cities.parquet&quot;)
us_cities_df.show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="reading-cloud-stored-data">
<h3><span class="section-number">28.9.6. </span>Reading Cloud-Stored Data<a class="headerlink" href="#reading-cloud-stored-data" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Read individual state wetlands data from S3 (DC wetlands - smaller dataset for demonstration)
url = &quot;s3a://us-west-2.opendata.source.coop/giswqs/nwi/wetlands/DC_Wetlands.parquet&quot;
df = sedona.read.format(&quot;parquet&quot;).load(url)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Display basic information about the dataset
df.show()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Convert WKB geometry to readable WKT format for inspection
df_wkt = df.withColumn(&quot;geometry&quot;, expr(&quot;ST_AsText(ST_GeomFromWKB(geometry))&quot;))
df_wkt.show()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Read all state wetlands data using wildcard pattern (75.8 GB total)
url = &quot;s3a://us-west-2.opendata.source.coop/giswqs/nwi/wetlands/*.parquet&quot;
df = sedona.read.format(&quot;parquet&quot;).load(url)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Count total wetland features across all states
# This operation may take several minutes due to the dataset size
df.count()
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="visualizing-vector-data">
<h2><span class="section-number">28.10. </span>Visualizing Vector Data<a class="headerlink" href="#visualizing-vector-data" title="Link to this heading">#</a></h2>
<section id="using-keplergl">
<h3><span class="section-number">28.10.1. </span>Using KeplerGL<a class="headerlink" href="#using-keplergl" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Configure the initial map view for global data
config = {
    &quot;mapState&quot;: {
        &quot;latitude&quot;: 20,  # Center latitude
        &quot;longitude&quot;: 0,  # Center longitude (prime meridian)
        &quot;zoom&quot;: 1,  # Global zoom level
        &quot;pitch&quot;: 0,  # Map tilt angle
        &quot;bearing&quot;: 0,  # Map rotation
    },
}
# Create initial map with cities data
m = SedonaKepler.create_map(cities_df, name=&quot;Cities&quot;, config=config)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Add additional layer to the existing map
SedonaKepler.add_df(m, countries_df, name=&quot;Countries&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Display the interactive map
m
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-pydeck">
<h3><span class="section-number">28.10.2. </span>Using PyDeck<a class="headerlink" href="#using-pydeck" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Create 3D geometry visualization for country boundaries
m = SedonaPyDeck.create_geometry_map(countries_df)
m
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Create scatterplot visualization for cities with custom point size
m = SedonaPyDeck.create_scatterplot_map(cities_df, radius_min_pixels=3)
m
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="writing-vector-data">
<h2><span class="section-number">28.11. </span>Writing Vector Data<a class="headerlink" href="#writing-vector-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Load the wetlands data for processing
url = &quot;s3a://us-west-2.opendata.source.coop/giswqs/nwi/wetlands/DC_Wetlands.parquet&quot;
df = sedona.read.format(&quot;parquet&quot;).load(url)
df.show()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Convert WKB geometry to Sedona geometry objects for spatial operations
df = df.withColumn(&quot;geometry&quot;, expr(&quot;ST_GeomFromWKB(geometry)&quot;))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Write to GeoParquet format with optimized partitioning
# Repartitioning to 10 partitions creates 10 output files for better performance
df.repartition(10).write.format(&quot;geoparquet&quot;).mode(&quot;overwrite&quot;).save(&quot;DE_Wetlands&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Write to GeoJSON format for compatibility with web applications
# GeoJSON is widely supported but less efficient for large datasets
df.write.format(&quot;geojson&quot;).mode(&quot;overwrite&quot;).save(&quot;DE_Wetlands_GeoJSON&quot;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="reading-raster-data">
<h2><span class="section-number">28.12. </span>Reading Raster Data<a class="headerlink" href="#reading-raster-data" title="Link to this heading">#</a></h2>
<section id="reading-netcdf">
<h3><span class="section-number">28.12.1. </span>Reading NetCDF<a class="headerlink" href="#reading-netcdf" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Load NetCDF file as binary data
df = sedona.read.format(&quot;binaryFile&quot;).load(&quot;wind_global.nc&quot;)

# Extract metadata information to understand the file structure
record_info_df = df.selectExpr(&quot;RS_NetCDFInfo(content) as record_info&quot;)

# Display metadata about variables, dimensions, and attributes
record_info = record_info_df.first()[&quot;record_info&quot;]
print(record_info)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Extract the u_wind variable as a raster using lon/lat coordinates
df = df.withColumn(&quot;raster&quot;, expr(&quot;RS_FromNetCDF(content, &#39;u_wind&#39;, &#39;lon&#39;, &#39;lat&#39;)&quot;))
df.show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="reading-geotiff">
<h3><span class="section-number">28.12.2. </span>Reading GeoTIFF<a class="headerlink" href="#reading-geotiff" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dem_df = sedona.read.format(&quot;binaryFile&quot;).load(&quot;dem_90m.tif&quot;)
dem_df = dem_df.withColumn(&quot;raster&quot;, expr(&quot;RS_FromGeoTiff(content)&quot;))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dem_df.show()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Create a temporary view to enable SQL operations on the raster data
dem_df.createOrReplaceTempView(&quot;dem_df&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Tile the raster into 256x256 pixel chunks for distributed processing
tiles_df = dem_df.selectExpr(&quot;RS_TileExplode(raster, 256, 256) as (x, y, raster)&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Display the tiled dataset - each row represents one tile
tiles_df.show()
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="visualizing-raster-data">
<h2><span class="section-number">28.13. </span>Visualizing Raster Data<a class="headerlink" href="#visualizing-raster-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Convert raster data to image format for visualization
htmlDF = dem_df.selectExpr(&quot;RS_AsImage(raster, 1000) as raster_image&quot;)
SedonaUtils.display_image(htmlDF)
</pre></div>
</div>
</div>
</div>
</section>
<section id="raster-map-algebra">
<h2><span class="section-number">28.14. </span>Raster Map Algebra<a class="headerlink" href="#raster-map-algebra" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dem_df.printSchema()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dem_df.createOrReplaceTempView(&quot;dem_df&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Create binary mask for areas above 2000m elevation using map algebra
mountain = sedona.sql(
    &quot;&quot;&quot;
SELECT
  RS_MapAlgebra(
    raster,
    &#39;D&#39;,
    &#39;out = (rast[0] &gt; 2000) ? 1 : 0;&#39;
  ) AS mountain
FROM dem_df
&quot;&quot;&quot;
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Display the results of the map algebra operation
mountain.show()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Visualize the binary mountain mask
htmlDF = mountain.selectExpr(&quot;RS_AsImage(mountain, 1000) as raster_image&quot;)
SedonaUtils.display_image(htmlDF)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Save the mountain classification raster as a GeoTIFF file
mountain.withColumn(&quot;raster_binary&quot;, expr(&quot;RS_AsGeoTiff(mountain)&quot;)).write.format(
    &quot;raster&quot;
).option(&quot;rasterField&quot;, &quot;raster_binary&quot;).option(&quot;fileExtension&quot;, &quot;.tiff&quot;).mode(
    &quot;overwrite&quot;
).save(
    &quot;mountain&quot;
)
</pre></div>
</div>
</div>
</div>
</section>
<section id="raster-zonal-statistics">
<h2><span class="section-number">28.15. </span>Raster Zonal Statistics<a class="headerlink" href="#raster-zonal-statistics" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Display the elevation raster structure for reference
dem_df.show()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Define a polygon representing a study area in the Sierra Nevada mountains
polygon = &quot;POLYGON((-119.715885 37.995326, -118.452104 37.995326, -118.452104 37.373679, -119.715885 37.373679, -119.715885 37.995326))&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Calculate average elevation within the study area polygon
mount_elev = sedona.sql(
    f&quot;&quot;&quot;
select
RS_ZonalStats(dem_df.raster, ST_Transform(
    ST_GeomFromText(&#39;{polygon}&#39;), &#39;EPSG:4326&#39;, &#39;EPSG:3857&#39;
    ), 1, &#39;avg&#39;, false, false) as avg_elev
from dem_df
&quot;&quot;&quot;
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Display the calculated average elevation
mount_elev.show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="writing-raster-data">
<h2><span class="section-number">28.16. </span>Writing Raster Data<a class="headerlink" href="#writing-raster-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Write the digital elevation model to GeoTIFF with compression
dem_df.withColumn(
    &quot;raster_binary&quot;, expr(&quot;RS_AsGeoTiff(raster, &#39;LZW&#39;, &#39;0.75&#39;)&quot;)
).write.format(&quot;raster&quot;).option(&quot;rasterField&quot;, &quot;raster_binary&quot;).option(
    &quot;pathField&quot;, &quot;path&quot;
).option(
    &quot;fileExtension&quot;, &quot;.tiff&quot;
).mode(
    &quot;overwrite&quot;
).save(
    &quot;dem&quot;
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Load NetCDF file containing global wind data
netcdf_df = sedona.read.format(&quot;binaryFile&quot;).load(&quot;wind_global.nc&quot;)

# Extract and display metadata to understand the data structure
record_info_df = netcdf_df.selectExpr(&quot;RS_NetCDFInfo(content) as record_info&quot;)

# Display metadata information
record_info = record_info_df.first()[&quot;record_info&quot;]
print(record_info)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Extract the u_wind component as a raster for analysis
netcdf_df = netcdf_df.withColumn(
    &quot;raster&quot;, expr(&quot;RS_FromNetCDF(content, &#39;u_wind&#39;, &#39;lon&#39;, &#39;lat&#39;)&quot;)
)
netcdf_df.show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="integration-with-geopandas">
<h2><span class="section-number">28.17. </span>Integration with GeoPandas<a class="headerlink" href="#integration-with-geopandas" title="Link to this heading">#</a></h2>
<section id="from-sedona-dataframe-to-geopandas-geodataframe">
<h3><span class="section-number">28.17.1. </span>From Sedona DataFrame to GeoPandas GeoDataFrame<a class="headerlink" href="#from-sedona-dataframe-to-geopandas-geodataframe" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Load and create spatial data in Sedona format
cities_df = (
    sedona.read.option(&quot;header&quot;, True)
    .format(&quot;CSV&quot;)
    .load(&quot;world_cities.csv&quot;)
    .withColumn(&quot;geometry&quot;, expr(&quot;ST_Point(longitude, latitude)&quot;))
)
cities_df.show()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Convert Sedona DataFrame to GeoPandas GeoDataFrame
df = cities_df.toPandas()  # Convert to Pandas DataFrame
gdf = gpd.GeoDataFrame(df, geometry=&quot;geometry&quot;)
gdf.crs = &quot;EPSG:4326&quot;  # Set coordinate reference system
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>gdf.explore()
</pre></div>
</div>
</div>
</div>
</section>
<section id="from-sedona-dataframe-to-geoarrow">
<h3><span class="section-number">28.17.2. </span>From Sedona DataFrame To GeoArrow<a class="headerlink" href="#from-sedona-dataframe-to-geoarrow" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Convert Sedona DataFrame to Apache Arrow format for efficient interchange
arrow = dataframe_to_arrow(cities_df)
arrow
</pre></div>
</div>
</div>
</div>
</section>
<section id="from-geopandas-geodataframe-to-sedona-dataframe">
<h3><span class="section-number">28.17.3. </span>From GeoPandas GeoDataFrame to Sedona DataFrame<a class="headerlink" href="#from-geopandas-geodataframe-to-sedona-dataframe" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Load geospatial data using GeoPandas
gdf = gpd.read_file(&quot;world_cities.geojson&quot;)
gdf.head()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Check the coordinate reference system
gdf.crs
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Convert GeoPandas GeoDataFrame directly to Sedona DataFrame
# Sedona automatically handles the geometry conversion
df = sedona.createDataFrame(gdf)
df.show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="advanced-integration-converting-through-geoarrow">
<h3><span class="section-number">28.17.4. </span>Advanced Integration: Converting Through GeoArrow<a class="headerlink" href="#advanced-integration-converting-through-geoarrow" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Convert Sedona DataFrame to Arrow format
arrow = dataframe_to_arrow(df)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Convert Arrow format back to GeoPandas
gdf = gpd.GeoDataFrame.from_arrow(arrow)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Display the reconstructed GeoPandas DataFrame
gdf.head()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Convert back to Sedona for further distributed processing
df = sedona.createDataFrame(gdf)
df.show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="custom-conversion-functions">
<h3><span class="section-number">28.17.5. </span>Custom Conversion Functions<a class="headerlink" href="#custom-conversion-functions" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Custom function to convert Sedona DataFrame to GeoPandas with error handling
def sedona_to_geopandas(sedona_df, geometry_col=&quot;geometry&quot;):
    &quot;&quot;&quot;Convert Sedona DataFrame to GeoPandas DataFrame with robust error handling&quot;&quot;&quot;
    # Convert spatial geometries to WKT format for transfer
    with_wkt = sedona_df.withColumn(&quot;wkt_geom&quot;, expr(f&quot;ST_AsText({geometry_col})&quot;))

    # Convert to Pandas DataFrame
    pandas_df = with_wkt.toPandas()

    # Convert WKT strings to Shapely geometries
    from shapely import wkt

    pandas_df[&quot;geometry&quot;] = pandas_df[&quot;wkt_geom&quot;].apply(wkt.loads)

    # Create GeoPandas GeoDataFrame
    gdf = gpd.GeoDataFrame(pandas_df.drop(&quot;wkt_geom&quot;, axis=1), geometry=&quot;geometry&quot;)

    return gdf


# Example usage: convert filtered dataset to GeoPandas
major_cities = world_cities_spatial.filter(col(&quot;population&quot;) &gt; 1000000)
major_cities_gdf = sedona_to_geopandas(major_cities)

print(f&quot;Converted {len(major_cities_gdf)} major cities to GeoPandas&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Display the converted major cities dataset
major_cities_gdf
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="real-world-use-cases">
<h2><span class="section-number">28.18. </span>Real-World Use Cases<a class="headerlink" href="#real-world-use-cases" title="Link to this heading">#</a></h2>
<section id="use-case-1-global-urban-density-analysis">
<h3><span class="section-number">28.18.1. </span>Use Case 1: Global Urban Density Analysis<a class="headerlink" href="#use-case-1-global-urban-density-analysis" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Analyze urban density patterns for cities with population &gt; 500,000
urban_analysis = (
    world_cities_spatial.filter(col(&quot;population&quot;) &gt; 500000)  # Focus on major cities
    .withColumn(
        &quot;urban_density&quot;,
        col(&quot;population&quot;)
        / expr(&quot;ST_Area(ST_Buffer(geometry, 10000))&quot;),  # People per mÂ² in 10km radius
    )
    .withColumn(
        &quot;city_category&quot;,
        expr(
            &quot;&quot;&quot;
        CASE
            WHEN population &gt; 5000000 THEN &#39;Megacity&#39;      -- Cities &gt; 5M people
            WHEN population &gt; 1000000 THEN &#39;Large City&#39;    -- Cities 1-5M people
            ELSE &#39;Medium City&#39;                              -- Cities 500K-1M people
        END
    &quot;&quot;&quot;
        ),
    )
)

# Calculate average density by city category
urban_analysis.groupBy(&quot;city_category&quot;).agg(
    expr(&quot;count(*)&quot;).alias(&quot;count&quot;),  # Number of cities in each category
    expr(&quot;avg(urban_density)&quot;).alias(&quot;avg_density&quot;),  # Average density per category
).show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-case-2-transit-accessibility-assessment">
<h3><span class="section-number">28.18.2. </span>Use Case 2: Transit Accessibility Assessment<a class="headerlink" href="#use-case-2-transit-accessibility-assessment" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Analyze potential transit coverage for cities with population &gt; 100,000
transit_analysis = (
    world_cities_spatial.filter(col(&quot;population&quot;) &gt; 100000)
    .withColumn(
        &quot;transit_coverage&quot;,
        expr(&quot;ST_Buffer(geometry, 1000)&quot;),  # 1km radius transit catchment area
    )
    .withColumn(
        &quot;coverage_area_km2&quot;,
        expr(&quot;ST_Area(ST_Buffer(geometry, 1000)) / 1000000&quot;),  # Convert mÂ² to kmÂ²
    )
)

# Calculate global transit accessibility metrics
accessibility_metrics = transit_analysis.agg(
    expr(&quot;avg(coverage_area_km2)&quot;).alias(
        &quot;avg_coverage_area&quot;
    ),  # Average coverage area per city
    expr(&quot;sum(coverage_area_km2)&quot;).alias(
        &quot;total_coverage_area&quot;
    ),  # Total potential coverage globally
)

accessibility_metrics.show()
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="key-takeaways">
<h2><span class="section-number">28.19. </span>Key Takeaways<a class="headerlink" href="#key-takeaways" title="Link to this heading">#</a></h2>
</section>
<section id="references-and-further-reading">
<h2><span class="section-number">28.20. </span>References and Further Reading<a class="headerlink" href="#references-and-further-reading" title="Link to this heading">#</a></h2>
</section>
<section id="exercises">
<h2><span class="section-number">28.21. </span>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-setting-up-sedona-and-basic-spatial-operations">
<h3><span class="section-number">28.21.1. </span>Exercise 1: Setting Up Sedona and Basic Spatial Operations<a class="headerlink" href="#exercise-1-setting-up-sedona-and-basic-spatial-operations" title="Link to this heading">#</a></h3>
</section>
<section id="exercise-2-working-with-real-geospatial-data">
<h3><span class="section-number">28.21.2. </span>Exercise 2: Working with Real Geospatial Data<a class="headerlink" href="#exercise-2-working-with-real-geospatial-data" title="Link to this heading">#</a></h3>
</section>
<section id="exercise-3-distance-analysis">
<h3><span class="section-number">28.21.3. </span>Exercise 3: Distance Analysis<a class="headerlink" href="#exercise-3-distance-analysis" title="Link to this heading">#</a></h3>
</section>
<section id="exercise-4-spatial-joins">
<h3><span class="section-number">28.21.4. </span>Exercise 4: Spatial Joins<a class="headerlink" href="#exercise-4-spatial-joins" title="Link to this heading">#</a></h3>
</section>
<section id="exercise-5-spatial-aggregation-and-clustering">
<h3><span class="section-number">28.21.5. </span>Exercise 5: Spatial Aggregation and Clustering<a class="headerlink" href="#exercise-5-spatial-aggregation-and-clustering" title="Link to this heading">#</a></h3>
</section>
<section id="exercise-6-buffer-analysis">
<h3><span class="section-number">28.21.6. </span>Exercise 6: Buffer Analysis<a class="headerlink" href="#exercise-6-buffer-analysis" title="Link to this heading">#</a></h3>
</section>
<section id="exercise-7-spatial-sql-queries">
<h3><span class="section-number">28.21.7. </span>Exercise 7: Spatial SQL Queries<a class="headerlink" href="#exercise-7-spatial-sql-queries" title="Link to this heading">#</a></h3>
</section>
<section id="exercise-8-advanced-spatial-analysis">
<h3><span class="section-number">28.21.8. </span>Exercise 8: Advanced Spatial Analysis<a class="headerlink" href="#exercise-8-advanced-spatial-analysis" title="Link to this heading">#</a></h3>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "giswqs/intro-gispro",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./book/geospatial"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="solara.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">27. </span>Building Interactive Dashboards with VoilÃ  and Solara</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">28.1. Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">28.2. Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-and-setting-up-apache-sedona">28.3. Installing and Setting Up Apache Sedona</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#installation-requirements">28.3.1. Installation Requirements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#core-imports-and-configuration">28.3.2. Core Imports and Configuration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-sedona-enabled-spark-session">28.3.3. Creating a Sedona-Enabled Spark Session</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-sample-data">28.4. Downloading Sample Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#core-concepts-and-data-structures">28.5. Core Concepts and Data Structures</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-spatial-dataframes">28.5.1. Understanding Spatial DataFrames</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-data-types">28.5.2. Spatial Data Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-spatial-dataframes">28.5.3. Creating Spatial DataFrames</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-real-geospatial-data">28.5.4. Working with Real Geospatial Data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-operations-and-functions">28.6. Spatial Operations and Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-geometric-properties">28.6.1. Basic Geometric Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-calculations">28.6.2. Distance Calculations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-relationships">28.6.3. Spatial Relationships</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-joins-and-indexing">28.7. Spatial Joins and Indexing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-spatial-join-types">28.7.1. Understanding Spatial Join Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-spatial-joins-with-world-cities">28.7.2. Performing Spatial Joins with World Cities</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-join-example-cities-by-country">28.7.3. Spatial Join Example: Cities by Country</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-spatial-analysis">28.8. Advanced Spatial Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-aggregations">28.8.1. Spatial Aggregations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-clustering-analysis">28.8.2. Spatial Clustering Analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-vector-data">28.9. Reading Vector Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-csv">28.9.1. Reading CSV</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-geojson">28.9.2. Reading GeoJSON</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-shapefiles">28.9.3. Reading Shapefiles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-geopackage">28.9.4. Reading GeoPackage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-geoparquet">28.9.5. Reading GeoParquet</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-cloud-stored-data">28.9.6. Reading Cloud-Stored Data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-vector-data">28.10. Visualizing Vector Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-keplergl">28.10.1. Using KeplerGL</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-pydeck">28.10.2. Using PyDeck</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-vector-data">28.11. Writing Vector Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-raster-data">28.12. Reading Raster Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-netcdf">28.12.1. Reading NetCDF</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-geotiff">28.12.2. Reading GeoTIFF</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-raster-data">28.13. Visualizing Raster Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#raster-map-algebra">28.14. Raster Map Algebra</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#raster-zonal-statistics">28.15. Raster Zonal Statistics</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-raster-data">28.16. Writing Raster Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#integration-with-geopandas">28.17. Integration with GeoPandas</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-sedona-dataframe-to-geopandas-geodataframe">28.17.1. From Sedona DataFrame to GeoPandas GeoDataFrame</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-sedona-dataframe-to-geoarrow">28.17.2. From Sedona DataFrame To GeoArrow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-geopandas-geodataframe-to-sedona-dataframe">28.17.3. From GeoPandas GeoDataFrame to Sedona DataFrame</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-integration-converting-through-geoarrow">28.17.4. Advanced Integration: Converting Through GeoArrow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-conversion-functions">28.17.5. Custom Conversion Functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#real-world-use-cases">28.18. Real-World Use Cases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-1-global-urban-density-analysis">28.18.1. Use Case 1: Global Urban Density Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-2-transit-accessibility-assessment">28.18.2. Use Case 2: Transit Accessibility Assessment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">28.19. Key Takeaways</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references-and-further-reading">28.20. References and Further Reading</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">28.21. Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-setting-up-sedona-and-basic-spatial-operations">28.21.1. Exercise 1: Setting Up Sedona and Basic Spatial Operations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-working-with-real-geospatial-data">28.21.2. Exercise 2: Working with Real Geospatial Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-distance-analysis">28.21.3. Exercise 3: Distance Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-spatial-joins">28.21.4. Exercise 4: Spatial Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-spatial-aggregation-and-clustering">28.21.5. Exercise 5: Spatial Aggregation and Clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-6-buffer-analysis">28.21.6. Exercise 6: Buffer Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-7-spatial-sql-queries">28.21.7. Exercise 7: Spatial SQL Queries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-8-advanced-spatial-analysis">28.21.8. Exercise 8: Advanced Spatial Analysis</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Qiusheng Wu
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>